
echo "Adding player repo: $REPOSITORY_REPO_NAME"
grep -q -F "$REPOSITORY_REPO_NAME" player_repos.txt || echo "$REPOSITORY_REPO_NAME" >> player_repos.txt

echo "Reading in players"
docker_command="docker run -it -v /var/run/docker.sock:/var/run/docker.sock wog_tournament "
while read player_repo; do
  if [ -n "$player_repo" ]; then
    echo $player_repo
    docker_command="$docker_command \"docker run -i $player_repo\""
  fi
done <player_repos.txt
echo "docker command: $docker_command"

game_id=$(date +%s)
echo "Starting new tournament: $game_id"
tournament_output_path="/tmp/tournament_results_${game_id}"
eval $docker_command > $tournament_output_path
echo "Tournament complete"

echo "Posting results"
echo "$game_id" >> tournament_results.txt
tail -n 1 $tournament_output_path >> tournament_results.txt

echo "Posting game output"
mv $tournament_output_path game_outputs/$game_id.txt

echo "Results: "
tail -n 1 game_outputs/$game_id.txt
